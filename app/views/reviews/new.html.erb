<script>
    var autocomplete;

    $(document).ready(function () {
        $('[data-behavior~=datepicker]').datepicker({
            startView: 2,
            todayBtn: "linked",
            autoclose: true
        });

        $("#address-search").focus();

        $('#review_building_rating').slider();
        $('#review_furnishings_rating').slider();
        $('#review_noise_rating').slider();
        $('#review_amenities_rating').slider();
        $('#review_transport_rating').slider();

        // create the autocomplete object, restricting the search to addresses
        autocomplete = new google.maps.places.Autocomplete(
                /** @type {HTMLInputElement} */(document.getElementById('address-search')),
                { types: ['geocode'] });
        google.maps.event.addListener(autocomplete, 'place_changed', function () {
            fillInAddress();
        });

        // precent enter key from submitting the form when choosing an address via autocomplete
        $('#address-search').keypress(function (event) {
            return event.keyCode != 13;
        });

        // show map and zoom to location if already present
        <% if (@review.decimal_degrees_latitude && @review.decimal_degrees_longitude) %>
            var location = new google.maps.LatLng(<%= @review.decimal_degrees_latitude %>, <%= @review.decimal_degrees_longitude %>);
            showMap(location, false);
        <% end %>


    })

    function geolocate() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                var geolocation = new google.maps.LatLng(
                        position.coords.latitude, position.coords.longitude);
                autocomplete.setBounds(new google.maps.LatLngBounds(geolocation,
                        geolocation));
            });
        }
    }

    function fillInAddress() {
        // Get the place details from the autocomplete object.
        var place = autocomplete.getPlace();

        // clear existing values
        document.getElementById('review_street_number').value = "";
        document.getElementById('review_route').value = "";
        document.getElementById('review_postal_town').value = "";
        document.getElementById('review_postal_code').value = "";

        // fill in hidden longitude and latitude
        setLatitude(place.geometry.location.lat());
        setLongitude(place.geometry.location.lng());

        for (var i = 0; i < place.address_components.length; i++) {
            var addressType = place.address_components[i].types[0];
            var addressLongName = place.address_components[i]['long_name'];

            // street_number
            if (addressType == 'street_number' && addressLongName) {
                document.getElementById('review_street_number').value = addressLongName;
            }

            // street
            if (addressType == 'route' && addressLongName) {
                document.getElementById('review_route').value = addressLongName;
            }

            // town
            if ($.inArray(addressType, ['postal_town', 'locality']) > -1 && addressLongName) {
                document.getElementById('review_postal_town').value = addressLongName;
            }

            // postal_code
            if ($.inArray(addressType, ['postal_code', 'postal_code_prefix']) > -1 && addressLongName) {
                document.getElementById('review_postal_code').value = addressLongName;
            }

            var div = document.getElementById('address');
            div.innerHTML = div.innerHTML + '<br /> Type:' + addressType + '. Short: ' + place.address_components[i]['short_name'] + '. Long: ' + place.address_components[i]['long_name'];
        }

           showMap(place.geometry.location, true);
    }

    function showMap(location, animate) {
        // center map on location
        var mapOptions = {
            zoom: 16,
            center: location,
            streetViewControl: false,
            scrollwheel: false,
        };

        map = new google.maps.Map(document.getElementById('map-canvas'),
                mapOptions);

        // add the draggable marker
        var marker = new google.maps.Marker({
            draggable: true,
            position: location,
            animation: animate ? google.maps.Animation.DROP: null,
            map: map,
            title: "Where you lived."
        });

        // update update hidden lng and lat fields whenever the marker is dragged
        google.maps.event.addListener(marker, 'dragend', function (event) {
            setLatitude(this.getPosition().lat());
            setLongitude(this.getPosition().lng());
        });

        // show the map div
        $('#map-container').show()
    }

    function setLatitude(latitude) {
        document.getElementById('review_decimal_degrees_latitude').value = latitude
    }

    function setLongitude(longitude) {
        document.getElementById('review_decimal_degrees_longitude').value = longitude
    }

</script>

<div class='container'>

  <h1>Write A Review</h1>

  <%= form_for @review, url: {action: "create"}, html: {class: 'form-horizontal'} do |f| %>

      <%= f.hidden_field :decimal_degrees_latitude %>
      <%= f.hidden_field :decimal_degrees_longitude %>

      <%= render 'shared/error_messages' %>

      <fieldset>
        <legend>Where did you live?</legend>
        <div class='form-group'>
          <label class="sr-only" for="search">Search for an address</label>

          <div class='col-sm-8'>
            <%= text_field_tag :search, params[:search], {:id => 'address-search', :class => 'form-control input-lg', :placeholder => 'Search for an address', :onFocus => 'geolocate()'} %>
          </div>
        </div>

        <div class='form-group'>
          <label class='col-sm-2 control-label' for="review_street_number">House Number</label>

          <div class='col-sm-4'>
            <%= f.text_field :street_number, class: 'form-control' %>
          </div>
        </div>

        <div class='form-group'>
          <label class='col-sm-2 control-label' for="review_route">Street</label>

          <div class='col-sm-6'>
            <%= f.text_field :route, class: 'form-control' %>
          </div>
        </div>

        <div class='form-group'>
          <label class='col-sm-2 control-label' for="review_postal_town">Town or City</label>

          <div class='col-sm-6'>
            <%= f.text_field :postal_town, class: 'form-control' %>
          </div>
        </div>

        <div class='form-group'>
          <label class='col-sm-2 control-label' for="review_postal_code">Postal Code</label>

          <div class='col-sm-6'>
            <%= f.text_field :postal_code, class: 'form-control' %>
          </div>
        </div>

        <div class='form-group' id='map-container'>
          <label class='col-sm-2 control-label' for="map">Exact Location</label>

          <div class='col-sm-6'>
            <span class='help-block'>Drag the marker to the right spot.</span>

            <div id="map-canvas"></div>
          </div>
        </div>

      </fieldset>


      <fieldset>
        <legend>When did you live there?</legend>

        <div class='form-group'>
          <label class='col-sm-2 control-label pull-left' for="review_start_date">Moved In</label>

          <div class='col-sm-2 input-group'>
            <%= f.text_field :start_date, class: 'form-control', data: {behavior: "datepicker"} %>
            <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
          </div>
        </div>
        <div class='form-group'>
          <label class='col-sm-2 control-label pull-left' for="review_end_date">Moved Out</label>

          <div class='col-sm-2 input-group'>
            <%= f.text_field :end_date, class: 'form-control', :placeholder => 'I still live there...', data: {behavior: "datepicker"} %>
            <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>What was it like?</legend>
        <p>Rate the below aspects of the property from 0 to 10 and add any comments you think will be useful.</p>

        <div class='form-group'>
          <label class='col-sm-2 control-label' for="review_building_rating">The Building</label>

          <div class='col-sm-6'>
            <%= f.text_field :building_rating, class: 'form-control', data: {:'slider-min' => "0", :'slider-max' => "10", :'slider-step' => "1", :'slider-value' => @review.building_rating ||= "5"} %>
            <span class='help-block'>What is the building like? Think about the entryways, security, lifts and stairways, parking. Any problems with damp or cracks in the walls?</span>
          </div>

          <label class='sr-only' for="review_building_comments">Building Comments</label>

          <div class='col-sm-6 col-sm-offset-2'>
            <%= f.text_area :building_comments, class: 'form-control' %>
          </div>
        </div>

        <div class='form-group'>
          <label class='col-sm-2 control-label' for="review_furnishings_rating">Furnishings</label>

          <div class='col-sm-6'>
            <%= f.text_field :furnishings_rating, class: 'form-control', data: {:'slider-min' => "0", :'slider-max' => "10", :'slider-step' => "1", :'slider-value' => @review.furnishings_rating ||= "5"} %>
            <span class='help-block'>Think about the furniture, fittings, and finishings. Are the kitchen units nice? Do all the windows work? Are there enough power sockets?</span>
          </div>

          <label class='sr-only' for="review_furnishings_comments">Furnishings Comments</label>

          <div class='col-sm-6 col-sm-offset-2'>
            <%= f.text_area :furnishings_comments, class: 'form-control' %>
          </div>
        </div>

        <div class='form-group'>
          <label class='col-sm-2 control-label' for="review_noise_rating">Noise</label>

          <div class='col-sm-6'>
            <%= f.text_field :noise_rating, class: 'form-control', data: {:'slider-min' => "0", :'slider-max' => "10", :'slider-step' => "1", :'slider-value' => @review.noise_rating ||= "5"} %>
            <span class='help-block'>Can you hear passing trains, traffic or the nearby school playground? How well insulated are you from the neighbours?</span>
          </div>

          <label class='sr-only' for="review_noise_comments">Noise Comments</label>

          <div class='col-sm-6 col-sm-offset-2'>
            <%= f.text_area :noise_comments, class: 'form-control' %>
          </div>
        </div>

        <div class='form-group'>
          <label class='col-sm-2 control-label' for="review_amenities_rating">Amenities</label>

          <div class='col-sm-6'>
            <%= f.text_field :amenities_rating, class: 'form-control', data: {:'slider-min' => "0", :'slider-max' => "10", :'slider-step' => "1", :'slider-value' => @review.amenities_rating ||= "5"} %>
            <span class='help-block'>Are there any good supermarkets, parks, coffee shops, gyms, launderettes, etc. nearby?</span>
          </div>

          <label class='sr-only' for="review_amenities_comments">Amenities Comments</label>

          <div class='col-sm-6 col-sm-offset-2'>
            <%= f.text_area :amenities_comments, class: 'form-control' %>
          </div>
        </div>

        <div class='form-group'>
          <label class='col-sm-2 control-label' for="review_transport_rating">Transport</label>

          <div class='col-sm-6'>
            <%= f.text_field :transport_rating, class: 'form-control', data: {:'slider-min' => "0", :'slider-max' => "10", :'slider-step' => "1", :'slider-value' => @review.transport_rating ||= "5"} %>
            <span class='help-block'>Are there nearby rail and bus services? Is there good bicycle access to the property?</span>
          </div>

          <label class='sr-only' for="review_transport_comments">Transport Comments</label>

          <div class='col-sm-6 col-sm-offset-2'>
            <%= f.text_area :transport_comments, class: 'form-control' %>
          </div>
        </div>
      </fieldset>

      <%= button_tag "Save Review", :name => nil, :class => 'btn btn-primary btn-lrg' %>
  <% end %>


</div>